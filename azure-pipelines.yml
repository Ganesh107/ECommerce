trigger: 
- none

stages:
- stage: build
  pool: 
    vmImage: 'windows-latest'
  jobs:
    # Build and publish backend projects
  - job: build_job
    #steps:
      # # Restore dependencies
      # - task: DotNetCoreCLI@2
      #   inputs:
      #     command: 'restore'
      #     projects: |
      #       app-backend/ECommerce.Service/ECommerce.Product.Service/ECommerce.Product.Service.csproj 
      #       app-backend/ECommerce.Service/ECommerce.Auth.Service/ECommerce.Auth.Service.csproj
     
      # # Build projects
      # - task: DotNetCoreCLI@2
      #   inputs:
      #     command: 'build'
      #     projects: |
      #       app-backend/ECommerce.Service/ECommerce.Product.Service/ECommerce.Product.Service.csproj 
      #       app-backend/ECommerce.Service/ECommerce.Auth.Service/ECommerce.Auth.Service.csproj

    # Build and publish database projects
  - job: publish
    steps:
    - task: VSBuild@1
      inputs:
        solution: app-backend/ECommerce.Database/ECommerce.Database.sqlproj
        platform: 'Any CPU' 
        configuration: 'Release'

    # Copy necessary files to the artifact staging directory
    - task: CopyFiles@2
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)/app-backend/ECommerce.Database/bin/Output' 
        TargetFolder: '$(Build.ArtifactStagingDirectory)'

    # Publish the build artifact
    - task: PublishBuildArtifacts@1
      inputs:
        PathToPublish: '$(Build.ArtifactStagingDirectory)'  
        ArtifactName: 'database_artifact'
        publishLocation: 'Container'

    - task: DownloadPipelineArtifact@2
      inputs:
        buildType: 'current'
        artifactName: 'database_artifact'
        targetPath: '$(Pipeline.Workspace)/dacpac'

- stage: Deploy
  dependsOn: build
  jobs:
  - deployment: DeployDacpac
    pool:
      vmImage: 'windows-latest'
    environment: 
      name: dev
      resourceName: ECommerceVM
      resourceType: VirtualMachine
    strategy:
      runOnce:
        deploy:
          steps:
          - powershell: |
              # Define paths and credentials
              $dacpacPath = '$(Pipeline.Workspace)/database_artifact/ECommerce.Database.dacpac'
              $sqlPackagePath = "C:\Program Files\Microsoft SQL Server\160\DAC\bin\SqlPackage.exe"
              $serverName = '$(server)'
              $databaseName = 'master'
              $username = '$(userName)'
              $password = '$(password)'

              # Debugging: Check if DACPAC file exists
              if (-Not (Test-Path $dacpacPath)) {
                  Write-Error "DACPAC file not found at $dacpacPath. Ensure it exists in the build output."
                  exit 1
              }

              # Debugging: Check if SqlPackage.exe exists
              if (-Not (Test-Path $sqlPackagePath)) {
                  Write-Error "SqlPackage.exe not found at $sqlPackagePath. Install it or verify the path."
                  exit 1
              }

              # Log paths for verification
              Write-Host "Using DACPAC file at: $dacpacPath"
              Write-Host "Using SqlPackage.exe at: $sqlPackagePath"

              # Execute SqlPackage.exe to deploy
              & "$sqlPackagePath" /Action:Publish `
                  /SourceFile:$dacpacPath `
                  /TargetServerName:$serverName `
                  /TargetDatabaseName:$databaseName `
                  /TargetUser:$username `
                  /TargetPassword:$password
            displayName: "Deploy DACPAC to SQL Server"
